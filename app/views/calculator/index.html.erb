<div class="max-w-md mx-auto p-6 bg-white rounded-2xl shadow">
  <h2 class="text-xl font-bold mb-4"> <%= t("calculator.title") %> </h2>
  <div style="margin-bottom: 10px;">
    <%= simple_form_for :calculator_entry, url: calculator_path, method: :post, html: { id: "calculator-form" } do |f| %>
      <div class="dashboard mb-4">
        <h4> <%= f.input :lessons, as: :integer, label: "Number of lessons per month",
                  input_html: { min: 0, class: "w-full p-2 border rounded" } %></h4>
      </div>
      <div class="dashboard mb-4">
        <h4> <%= f.input :attendees, as: :integer, label: "Average attendees per lesson (max 50)",
                  input_html: { min: 0, max: 50, class: "w-full p-2 border rounded" } %></h4>
      </div>
      <div class="dashboard mb-4">
        <h4> <%= f.input :price, as: :integer, label: "Price per lesson (¥)",
                  input_html: { min: 0, class: "w-full p-2 border rounded" } %></h4>
      </div>
      <h4><%= f.button :submit, "Calculate", class: "btn btn-calculate" %></h4>
    <% end %>
  </div>
  <div id="result" class="mt-4 text-lg font-semibold"></div>
  <!-- Name & Email section (hidden initially) -->
  <div id="guest-info-section" class="mt-4" style="display: none;">
    <label class="block mb-2 font-medium">Your Name</label>
    <input id="guest_name" type="text" class="w-full p-2 border rounded mb-2">
    <label class="block mb-2 font-medium">Your Email</label>
    <input id="guest_email" type="email" class="w-full p-2 border rounded mb-2">
    <button onclick="saveGuestInfo()"
          class="btn btn-send-info mt-4">
      Send me informations!
    </button>
    <div id="guest-info-result" class="mt-2"></div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("calculator-form");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const lessons = parseInt(form.querySelector("#calculator_entry_lessons").value) || 0;
    const attendees = Math.min(parseInt(form.querySelector("#calculator_entry_attendees").value) || 0, 50);
    const price = parseInt(form.querySelector("#calculator_entry_price").value) || 0;

    const token = document.querySelector('meta[name="csrf-token"]').content;

    const response = await fetch(form.action, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": token
      },
      body: JSON.stringify({ calculator_entry: { lessons, attendees, price } })
    });

    const data = await response.json();

    let resultText = `Your monthly commission: ¥${data.commission.toLocaleString()}. `;
    const resultDiv = document.getElementById("result");

    if (data.status === "eligible") {
      resultText += "✅ You are eligible!";
  resultDiv.setAttribute("style", "color: #292A5A; font-weight: 300; margin-top: 1rem;");
    } else if (data.status === "negotiable") {
      resultText += "⚖️ Not eligible, but negotiable.";
  resultDiv.setAttribute("style", "color: #292A5A; font-weight: 300; margin-top: 1rem;");
    } else {
      resultText += "❌ You are not eligible.";
  resultDiv.setAttribute("style", "color: #292A5A; font-weight: 300; margin-top: 1rem;");
    }

    resultDiv.innerText = resultText;

   if (data.commission > 15000) {
  document.getElementById("guest-info-section").style.display = "block";
  } else {
  document.getElementById("guest-info-section").style.display = "none";
  }
  });
  });
</script>
