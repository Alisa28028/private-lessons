<div class="max-w-md mx-auto p-6 bg-white rounded-2xl shadow">
  <h2 class="text-xl font-bold mb-4"><%= t("calculator.title") %></h2>
  <div style="margin-bottom: 10px;">
    <%= simple_form_for :calculator_entry, url: calculator_path, method: :post, html: { id: "calculator-form", data: { turbo: false } } do |f| %>
      <div class="dashboard mb-4">
        <h4> <%= f.input :lessons, as: :integer, label: t("calculator.nb_lessons"),
                  input_html: { min: 0, class: "w-full p-2 border rounded" } %></h4>
      </div>
      <div class="dashboard mb-4">
        <h4> <%= f.input :attendees, as: :integer, label: t("calculator.nb_students"),
                  input_html: { min: 0, max: 50, class: "w-full p-2 border rounded" } %></h4>
      </div>
      <div class="dashboard mb-4">
        <h4> <%= f.input :price, as: :integer, label: t("calculator.price"),
                  input_html: { min: 0, class: "w-full p-2 border rounded" } %></h4>
      </div>
      <h4><%= f.button :submit, t("calculator.calculate"), class: "btn btn-calculate" %></h4>
    <% end %>
  </div>
  <div id="result" class="mt-4 text-lg font-semibold"></div>
  <!-- Name & Email section (hidden initially) -->
  <div id="guest-info-section" class="mt-4" style="display: none;">
    <div class="dashboard d-flex flex-column">
      <h4><label class="block mb-2 font-medium"><%= t("calculator.name") %></label></h4>
      <input id="guest_name" type="text" class="w-full p-2 border rounded mb-2">
    </div>
    <div class="dashboard d-flex flex-column">
      <h4><label class="block mb-2 font-medium"><%= t("calculator.email") %></label></h4>
      <input id="guest_email" type="email" class="w-full p-2 border rounded mb-2">
    </div>
    <button onclick="saveGuestInfo()" class="btn btn-send-info mt-4">
      <%= t("calculator.send_info") %>
    </button>
    <div id="guest-info-result" class="mt-2"></div>
  </div>
</div>
<script>
  document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("calculator-form");
  const resultDiv = document.getElementById("result");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const lessons = parseInt(form.querySelector("#calculator_entry_lessons").value) || 0;
    const attendees = Math.min(parseInt(form.querySelector("#calculator_entry_attendees").value) || 0, 50);
    const price = parseInt(form.querySelector("#calculator_entry_price").value) || 0;

    const token = document.querySelector('meta[name="csrf-token"]').content;

    const response = await fetch(form.action, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRF-Token": token
      },
      body: JSON.stringify({ calculator_entry: { lessons, attendees, price } })
    });

    const data = await response.json();

    // let resultText = `月間コミッション: ¥${data.commission.toLocaleString()}。 `;

    let resultText = "";

    if (data.status === "eligible") {
      resultText += "おめでとうございます！対象です🎉メールアドレスを登録して、詳細をご案内します。";
      resultDiv.setAttribute("style", "color: #292A5A; font-weight: 300; margin-top: 1rem;");
    } else if (data.status === "negotiable") {
      resultText += "⚖️ 条件は満たしていませんが、相談可能です。";
      resultDiv.setAttribute("style", "color: #292A5A; font-weight: 300; margin-top: 1rem;");
    } else {
      resultText += "❌ 現在は対象外ですが、条件が変わった際にご案内できるよう、メールアドレスをご登録ください。";
      resultDiv.setAttribute("style", "color: #292A5A; font-weight: 300; margin-top: 1rem;");
    }

    resultDiv.innerText = resultText;

    // Show guest info if commission > 15,000

      document.getElementById("guest-info-section").style.display = "block";

  });
  });
</script>
