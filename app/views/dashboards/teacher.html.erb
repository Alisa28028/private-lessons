<div class="main-content">
  <div class="container-dashboard-top">
    <div class="row">
      <div class="col-12">
        <%# <% if current_user.events.any? || current_user.bookings.any? %>
        <div class="d-flex justify-content-between mt-4 mb-2">
          <%= link_to dashboard_path(view: "student"), class: "btn btn-switch-dashboard" do %>
            <%= t("dashboard.student") %> <i class="fa-solid fa-circle-right me-2"></i>
          <% end %>
          <div class="overlay-text">
            <h1 class="d-flex justify-content-center dashboard-h2 mt-6"> <%= t("dashboard.teacher") %>
            </h1>
            <h2 class="dashboard-h4 mb-0"><%= t("dashboard.stats") %></h2>
          </div>
          <div class="column mx-3">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="d-flex flex-column">
  <div class="d-flex flex-column gap-1 mx-4">
    <div class="d-flex flex-row gap-2">
      <div class="container-dashboard-stats">
        <div class="d-flex justify-content-center px-3">
          <button
  type="button"
  class="unstyled-button"
  data-bs-toggle="offcanvas"
  data-bs-target="#bookingPanel"
  aria-controls="bookingPanel"
>
            <h3 class="text-center <%= I18n.locale == :ja ? 'mt-3' : 'mt-2 mb-2' %> dashboard-h3">
              <%= t("dashboard.total_b") %>
            </h3>
            <h1 class="d-flex justify-content-center dashboard-numbers"><%= @event_instances.sum { |instance| instance.bookings.where(status: "confirmed").count } %></h1>
          </button>
        </div>
      </div>
      <div class="container-dashboard-stats">
        <div class="d-flex justify-content-center px-3">
          <button
  type="button"
  class="unstyled-button"
  data-bs-toggle="offcanvas"
  data-bs-target="#bookingPanel"
  aria-controls="bookingPanel"
>
            <h3 class="text-center <%= I18n.locale == :ja ? 'mt-3' : 'mt-2 mb-2' %> dashboard-h3">
              <%= t("dashboard.pending") %>
            </h3>
            <h1 class="d-flex justify-content-center dashboard-numbers"><%= @event_instances.sum { |instance| instance.bookings.where(status: "pending", waitlisted: false).count } %></h1>
          </button>
        </div>
      </div>
      <div class="container-dashboard-stats">
        <div class="d-flex justify-content-center px-3">
          <button
  type="button"
  class="unstyled-button"
  data-bs-toggle="offcanvas"
  data-bs-target="#attendeePanel"
  aria-controls="attendeePanel"
>
            <h3 class="text-center <%= I18n.locale == :ja ? 'mt-3' : 'mt-2 mb-2' %> dashboard-h3">
              <%= t("dashboard.unpaid_b") %>
            </h3>
            <h1 class="d-flex justify-content-center dashboard-numbers"><%= @unpaid_booking_count %></h1>
          </button>
        </div>
      </div>
    </div>
    <div class="d-flex flex-row gap-2">
      <div class="container-dashboard-earnings">
        <h3 class="d-flex justify-content-center mt-3 dashboard-h3"><%= t("dashboard.total_e") %></h3>
        <h1 class="d-flex justify-content-center dashboard-numbers">
          <%= number_to_currency(@current_month_paid_sum, unit: "¥", precision: 0) %>
        </h1>
      </div>
    </div>
  </div>
  <div class="d-flex flex-column mx-2 mt-3">
    <button type="button"
        class="d-flex flex-row align-items-center justify-content-between w-100 border-0 bg-transparent py-2 px-3"
        data-bs-toggle="offcanvas"
        data-bs-target="#attendeePanel"
        aria-controls="attendeePanel"
        style="text-align: left;">
      <span style="font-family: 'Inter'; font-size: 15px; color: #292A5A; font-weight: 500;">
        <%= t("dashboard.manage_p") %>
      </span>
      <i class="fa-solid fa-chevron-right fa-sm"></i>
    </button>
    <button type="button"
        class="d-flex flex-row align-items-center justify-content-between w-100 border-0 bg-transparent py-2 px-3 mb-3"
        data-bs-toggle="offcanvas"
        data-bs-target="#bookingPanel"
        aria-controls="bookingPanel"
        style="text-align: left;">
      <span style="font-family: 'Inter'; font-size: 15px; color: #292A5A; font-weight: 500;">
        <%= t("dashboard.manage_b") %>
      </span>
      <i class="fa-solid fa-chevron-right fa-sm"></i>
    </button>
    <%# </div>
  </div> %>
    <!-- Offcanvas Panel for payments -->
    <!-- Offcanvas Panel for payments -->
    <%# <turbo-frame id="payments_panel_frame" src="<%= payments_dashboard_path %>
    <div class="offcanvas offcanvas-end mb-5" tabindex="-1" id="attendeePanel" aria-labelledby="attendeePanelLabel">
      <div class="d-flex flex-column">
        <div class="offcanvas-header" style="margin-bottom: -18px;">
          <h2 class="offcanvas-title" id="attendeePanelLabel"> <%= t("dashboard.payment_panel") %></h2>
          <button
  type="button"
  class="btn-close"
  data-bs-dismiss="offcanvas"
  aria-label="Close"
  onclick="location.reload();">
          </button>
        </div>
        <div class="ms-3 mb-3">
          <%= link_to teacher_dashboard_path, class: "text-dark text-decoration-none", style: "font-family: Inter, sans-serif;" do  %>
            <i class="fa-regular fa-circle-left"></i> <%= t("dashboard.back") %>
          <% end %>
        </div>
      </div>
      <!-- Header with buttons -->
      <div class="d-flex flex-column mb-3 mx-3">
        <a href="#past-events" class="btn btn-card active ml-2 mr-0 me-2 mb-0 mt-1" style= "font-family: Inter, sans-serif;" data-no-close="true"><%= t("classes.past") %></a>
        <a href="#future-events" class="btn btn-card ml-2 mr-0 me-2" style= "font-family: Inter, sans-serif;" data-no-close="true"><%= t("classes.upcoming") %></a>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const buttons = document.querySelectorAll('.btn-card');

          buttons.forEach(button => {
            button.addEventListener('click', function (e) {
              buttons.forEach(btn => btn.classList.remove('active'));
              this.classList.add('active');

              // Optional: smooth scroll to section
              const targetId = this.getAttribute('href');
              const target = document.querySelector(targetId);
              if (target) {
                e.preventDefault(); // avoid default jump
                target.scrollIntoView({ behavior: 'smooth' });
              }
            });
          });
        });
      </script>
      <div class="offcanvas-body">
        <h3 id="past-events" class="mb-4"><%= t("classes.past") %></h3>
        <div>
          <% @past_event_instances_created.each do |instance| %>
            <% if instance.bookings.any? %>
              <%= link_to event_instance_path(instance) do %>
                <div class="panel mb-3">
                  <hr style="border: none; height: 1px; background-color: #686565ba; margin: 1rem 0;">
                  <h4 class= "panel d-flex align-items-center">
                    <%= instance.event.title.upcase %>
                    <div style="margin-bottom: 2px; margin-left: 5px">
                      <i class="fa-solid fa-arrow-up-right-from-square" style="font-size: 13px;"></i>
                    </div>
                  </h4>
                <% end %>
                <% time_zone_str = current_user&.time_zone.presence || "Asia/Tokyo" %>
                <% time_zone = ActiveSupport::TimeZone[time_zone_str] || ActiveSupport::TimeZone["UTC"] %>
                <h6 class="panel mb-2"> <%= instance.start_time.strftime("%Y/%m/%d (%a)") %>
                  <%= l(instance.start_time.in_time_zone(time_zone), format: :short_day_with_time) %>
                </h6>
                <% instance.bookings.reject { |b| b.waitlisted || b.status == "rejected_by_teacher" || (b.status == "cancelled_by_student" && b.cancelled_by == "student") }.each do |booking| %>
                  <turbo-frame id="payment_<%= booking.id %>">
                    <div class="d-flex justify-content-between align-items-baseline" style="margin-bottom: 5px; height: 28px;">
                      <div class="d-flex align-items-end" style="margin-top: -6px;">
                        <i class="fa-solid fa-caret-right caret-icon me-1" data-booking-id="<%= booking.id %>"></i>
                        <h6 class="panel">
                          <a
  class="text-decoration-none"
  style="color: black;"
  data-bs-toggle="collapse"
  data-bs-target="#dropdown_<%= booking.id %>"
  aria-expanded="false"
  aria-controls="dropdown_<%= booking.id %>"
  data-booking-id="<%= booking.id %>"
>
                            <%= booking.user.first_name %> -
                          </h6>
                          <% if booking.state == 'paid' %>
                            <h6 class="panel" style="color: #5e9e6b !important; font-weight: 600 !important;"> <%= t("dashboard.paid") %>
                              ✅</h6>
                          <% elsif booking.state == 'unpaid' %>
                            <h6 class="panel" style="color: #eb4e5a !important; font-weight: 600 !important;"> <%= t("dashboard.unpaid") %>
                            </h6>
                          <% elsif booking.state == 'waived' %>
                            <h6 class="panel">- <%= t("dashboard.waived") %>
                            </h6>
                          <% end %>
                        </a>
                      </div>
                      <% if booking.state == 'unpaid' %>
                        <% if booking.status == "cancelled_by_teacher" && booking.cancelled_by == "teacher" %>
                          <div class="d-flex align-items-center">
                            <%= button_to t("dashboard.waive"), update_payment_state_booking_path(booking, state: "waived"),
        method: :patch,
        data: { turbo_frame: "payment_#{booking.id}" },
        class: "btn btn-sm",
                    style: "background-color: #543A70; height: 28px; line-height: 10px; border-radius: 14px; width: 85px; color: white; margin-right: 3px;"

        %>
                            <%= button_to t("dashboard.mark_paid"), update_payment_state_booking_path(booking, state: "paid"),
        method: :patch,
        data: { turbo_frame: "payment_#{booking.id}" },
        class: "btn btn-sm",
            style: "background-color: #9bdaa7; height: 28px; line-height: 10px; border-radius: 14px; padding-right: 10px; padding-left: 10px; color: white;"
                            %>
                          </div>
                        <% else %>
                          <%= button_to t("dashboard.mark_paid"), update_payment_state_booking_path(booking, state: "paid"),
        method: :patch,
        data: { turbo_frame: "payment_#{booking.id}" },
        class: "btn btn-sm",
        style: "background-color: #9bdaa7; height: 28px; line-height: 10px; border-radius: 14px; padding-right: 10px; padding-left: 10px; color: white;"
%>
                        <% end %>
                      <% else %>
                        <%= button_to update_payment_state_booking_path(booking, state: 'unpaid'), method: :patch, data: { turbo_frame: "booking_#{booking.id}" },
                          class: "btn btn-sm",
                          style: "background-color: black; height: 28px; line-height: 11px; color: white; border-radius: 14px; padding-right: 10px; padding-left: 10px;" do %>
                          <%= t("dashboard.mark_unpaid") %>
                        <% end %>
                      <% end %>
                    </div>
                    <!-- Dropdown Content -->
                    <div class="collapse mt-2" id="dropdown_<%= booking.id %>" data-controller="collapse">
                      <div class="p-2" style="border-radius: 5px;">
                        <!-- You can put any additional booking details here -->
                        <%= link_to user_path(booking.user), data: { turbo_frame: "_top" }, class: "d-flex align-items-end" do %>
                          <% if booking.user.photo.present? %>
                            <%= cl_image_tag booking.user.photo.key, class: "avatar-showpage", alt: "avatar-bordered" %>
                          <% else %>
                            <%= image_tag "default-avatar.png", class: "avatar-showpage" %>
                          <% end %>
                          <h6 class="panel" style="margin-left: 2px;">
                            <%= t("dashboard.view_p") %>
                          </h6>
                        <% end %>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 3px;"><i class="fa-solid fa-envelope"></i></h6>
                          <h6 class="panel" style="margin-left: 6px;">  <%= booking.user.email %></h6>
                        </div>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 4px;"><i class="fa-solid fa-mobile-screen-button"></i> </h6>
                          <h6 style="margin-left: 8px;">
                            <%= booking.user.phone_number %></h6>
                        </div>
                        <div class="panel" style="margin-left: 3px;">
                          <h6><%= t("dashboard.created_at") %>
                            <%= l(booking.created_at.in_time_zone(time_zone), format: :short_day_with_time) %>
                          </h6>
                        </div>
                      </div>
                    </div>
                  </turbo-frame>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
        <div>
          <h3 id="future-events" class="mt-5 mb-4"><%= t("classes.upcoming") %></h3>
          <% @upcoming_event_instances_created.each do |instance| %>
            <% if instance.bookings.any? %>
              <%= link_to event_instance_path(instance) do %>
                <div class="panel mb-3">
                  <hr style="border: none; height: 1px; background-color: #686565ba; margin: 1rem 0;">
                  <h4 class= "panel d-flex align-items-center"><%= instance.event.title.upcase %>
                    <div style="margin-bottom: 2px; margin-left: 5px"> <i class="fa-solid fa-arrow-up-right-from-square" style="font-size: 13px;"></i></div>
                  </h4>
                <% end %>
                <% time_zone_str = current_user&.time_zone.presence || "Asia/Tokyo" %>
                <% time_zone = ActiveSupport::TimeZone[time_zone_str] || ActiveSupport::TimeZone["UTC"] %>
                <h6 class="panel mb-2"> <%= instance.start_time.strftime("%Y/%m/%d (%a)") %>
                  <%= l(instance.start_time.in_time_zone(time_zone), format: :short_day_with_time) %>
                </h6>
                <% instance.bookings.reject { |b| b.waitlisted || b.status == "rejected_by_teacher" || (b.status == "cancelled_by_student" && b.cancelled_by == "student") }.each do |booking| %>
                  <%# <% if booking.status == 'confirmed' %>
                  <turbo-frame id="payment_<%= booking.id %>">
                    <!-- Turbo frame with buttons and state here -->
                    <div class="d-flex justify-content-between align-items-baseline" style="margin-bottom: 5px; height: 28px;">
                      <div class="d-flex align-items-end" style="margin-top: -6px;">
                        <i class="fa-solid fa-caret-right caret-icon me-1" data-booking-id="<%= booking.id %>"></i>
                        <h6 class="panel">
                          <a
  class="text-decoration-none"
  style="color: black;"
  data-bs-toggle="collapse"
  data-bs-target="#dropdown_<%= booking.id %>"
  role="button"
  aria-expanded="false"
  aria-controls="dropdown_<%= booking.id %>"
  data-booking-id="<%= booking.id %>"
>
                            <%= booking.user.first_name %> -
                          </h6>
                          <% if booking.state == 'paid' %>
                            <h6 class="panel" style="color: #5e9e6b !important; font-weight: 600 !important;"> <%= t("dashboard.paid") %>
                              ✅</h6>
                          <% elsif booking.state == 'unpaid' %>
                            <h6 class="panel" style="color: #eb4e5a !important; font-weight: 600 !important;"> <%= t("dashboard.unpaid") %>
                            </h6>
                          <% elsif booking.state == 'waived' %>
                            <h6 class="panel">- <%= t("dashboard.waived") %>
                            </h6>
                          <% end %>
                        </a>
                      </div>
                      <% if booking.state == 'unpaid' %>
                        <% if booking.status == "cancelled_by_teacher" && booking.cancelled_by == "teacher" %>
                          <div class="d-flex align-items-center">
                            <%= button_to t("dashboard.waive"), update_payment_state_booking_path(booking, state: "waived"),
        method: :patch,
        data: { turbo_frame: "payment_#{booking.id}" },
        class: "btn btn-sm",
                    style: "background-color: #543A70; height: 28px; line-height: 10px; border-radius: 14px; padding-right: 10px; padding-left: 10px; color: white; margin-right: 3px"

        %>
                            <%= button_to t("dashboard.mark_paid"), update_payment_state_booking_path(booking, state: "paid"),
        method: :patch,
        data: { turbo_frame: "payment_#{booking.id}" },
        class: "btn btn-sm",
            style: "background-color: #9bdaa7; height: 28px; line-height: 10px; border-radius: 14px; padding-right: 10px; padding-left: 10px; color: white;"
                            %>
                          </div>
                        <% else %>
                          <%= button_to t("dashboard.mark_paid"), update_payment_state_booking_path(booking, state: "paid"),
        method: :patch,
        data: { turbo_frame: "payment_#{booking.id}" },
        class: "btn btn-sm",
        style: "background-color: #9bdaa7; height: 28px; line-height: 10px; border-radius: 14px; padding-right: 10px; padding-left: 10px; color: white;"
%>
                        <% end %>
                      <% else %>
                        <%= button_to update_payment_state_booking_path(booking, state: 'unpaid'), method: :patch, data: { turbo_frame: "booking_#{booking.id}" },
                        class: "btn btn-sm",
                        style: "background-color: black; height: 28px; line-height: 11px; color: white; border-radius: 14px; padding-right: 10px; padding-left: 10px;" do %>
                          <%= t("dashboard.mark_unpaid") %>
                        <% end %>
                      <% end %>
                    </div>
                    <!-- Dropdown Content -->
                    <div class="collapse mt-2" id="dropdown_<%= booking.id %>" data-controller="collapse">
                      <div class="p-2" style="border-radius: 5px;">
                        <!-- You can put any additional booking details here -->
                        <%= link_to user_path(booking.user), data: { turbo_frame: "_top" }, class: "d-flex align-items-end" do %>
                          <% if booking.user.photo.present? %>
                            <%= cl_image_tag booking.user.photo.key, class: "avatar-showpage", alt: "avatar-bordered" %>
                          <% else %>
                            <%= image_tag "default-avatar.png", class: "avatar-showpage" %>
                          <% end %>
                          <h6 class="panel" style="margin-left: 2px;">
                            <%= t("dashboard.view_p") %> </h6>
                        <% end %>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 3px;"><i class="fa-solid fa-envelope"></i></h6>
                          <h6 class="panel" style="margin-left: 6px;">  <%= booking.user.email %></h6>
                        </div>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 4px;"><i class="fa-solid fa-mobile-screen-button"></i> </h6>
                          <h6 style="margin-left: 8px;">
                            <%= booking.user.phone_number %></h6>
                        </div>
                        <h6 class="panel" style="margin-left: 3px;"><%= t("dashboard.created_at") %>
                          <%= l(booking.created_at.in_time_zone(time_zone), format: :short_day_with_time) %>
                        </h6>
                      </div>
                    </div>
                  </turbo-frame>
                  <%# <% end %>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <%# adding another button and panel for bookings management %>
    <!-- Offcanvas Panel for bookings -->
    <div class="offcanvas offcanvas-end mb-5" tabindex="-1" id="bookingPanel" aria-labelledby="bookingPanelLabel">
      <div class="d-flex flex-column">
        <div class="offcanvas-header" style="margin-bottom: -18px;">
          <h2 class="offcanvas-title" id="bookingPanelLabel"> <%= t("dashboard.booking_panel") %></h2>
          <button
  type="button"
  class="btn-close"
  data-bs-dismiss="offcanvas"
  aria-label="Close"
  onclick="location.reload();">
          </button>
        </div>
        <div class="ms-3 mb-3">
          <%= link_to teacher_dashboard_path, class: "text-dark text-decoration-none", style: "font-family: Inter, sans-serif;" do  %>
            <i class="fa-regular fa-circle-left"></i> <%= t("dashboard.back") %>
          <% end %>
        </div>
      </div>
      <!-- Header with buttons -->
      <div class="d-flex flex-column mb-3 mx-3">
        <a href="#past-events" class="btn btn-card active ml-2 mr-0 me-2 mb-0 mt-1" style= "font-family: Inter, sans-serif;" data-no-close="true"><%= t("classes.past") %></a>
        <a href="#future-events" class="btn btn-card ml-2 mr-0 me-2" style= "font-family: Inter, sans-serif;" data-no-close="true"><%= t("classes.upcoming") %></a>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const buttons = document.querySelectorAll('.btn-card');

          buttons.forEach(button => {
            button.addEventListener('click', function (e) {
              buttons.forEach(btn => btn.classList.remove('active'));
              this.classList.add('active');

              // Optional: smooth scroll to section
              const targetId = this.getAttribute('href');
              const target = document.querySelector(targetId);
              if (target) {
                e.preventDefault(); // avoid default jump
                target.scrollIntoView({ behavior: 'smooth' });
              }
            });
          });
        });
      </script>
      <div class="offcanvas-body">
        <h3 id="future-events" class="mt-5 mb-4"><%= t("classes.upcoming") %></h3>
        <div>
          <% @upcoming_event_instances_created.each do |instance| %>
            <% if instance.bookings.any? %>
              <%= link_to event_instance_path(instance), class: "text-decoration-none" do %>
                <div class="panel mb-3">
                  <h4 class="panel d-flex align-items-center">
                    <%= instance.event.title.upcase %>
                    <div style="margin-bottom: 2px; margin-left: 5px">
                      <i class="fa-solid fa-arrow-up-right-from-square" style="font-size: 13px;"></i>
                    </div>
                  </h4>
                <% end %>
                <% time_zone_str = current_user&.time_zone.presence || "Asia/Tokyo" %>
                <% time_zone = ActiveSupport::TimeZone[time_zone_str] || ActiveSupport::TimeZone["UTC"] %>
                <h6 class="panel mb-3"> <%= instance.start_time.strftime("%Y/%m/%d (%a)") %>
                  <%= l(instance.start_time.in_time_zone(time_zone), format: :short_day_with_time) %>
                </h6>
                <% instance.bookings.each do |booking| %>
                  <turbo-frame id="booking_<%= booking.id %>">
                    <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 5px; height: 28px;">
                      <div class="d-flex align-items-end" style="margin-top: -6px;">
                        <i class="fa-solid fa-caret-right caret-icon me-1" data-booking-id="<%= booking.id %>"></i>
                        <h6 class="panel">
                          <a
                  class="text-decoration-none"
                  style="color: black;"
                  data-bs-toggle="collapse"
                  data-bs-target="#dropdown_<%= booking.id %>"
                  aria-expanded="false"
                  aria-controls="dropdown_<%= booking.id %>"
                  data-booking-id="<%= booking.id %>"
                >
                            <%= booking.user.first_name %> -
                          </h6>
                          <h6 class="panel" style="<%= 'color: #5e9e6b; font-weight: 600;' if booking.status == 'confirmed' %>">
                            <% if booking.status == 'confirmed' %>
                              <%= t("dashboard.confirmed") %>
                            <% elsif booking.status == 'pending' %>
                              <%= t("dashboard.pending") %>
                            <% elsif booking.status == 'rejected_by_teacher' %>
                              <%= t("dashboard.declined") %>
                            <% elsif booking.status == 'cancelled_by_teacher' %>
                              <%= t("dashboard.cancelled_by_t") %>
                            <% elsif booking.status == 'cancelled_by_student' %>
                              <%= t("dashboard.cancelled_by_s") %>
                            <% elsif booking.status == 'completed' %>
                              <%= t("dashboard.completed") %>
                            <% end %>
                          </h6>
                        </div>
                      </a>
                      <% if booking.status == 'pending' %>
                        <div class="d-flex align-items-between">
                          <% if instance.active_bookings_count < instance.effective_capacity.to_i %>
                            <%= button_to t("dashboard.approve"), update_status_booking_path(booking, status: "confirmed"), method: :patch,
                      class: "btn btn-sm", style: "background-color: #9bdaa7; height: 28px; line-height: 10px; border-radius: 14px; width: 95px; color: white; margin-right: 4px",
                      data: { turbo_method: :patch, turbo_frame: "booking_#{booking.id}" } %>
                          <% else %>
                            <button class="btn btn-sm disabled" style="height: 28px; line-height: 10px; border-radius: 14px; width: 95px; color: black; margin-right: 4px;" disabled>
                              <%= t("dashboard.full") %>
                            </button>
                          <% end %>
                          <%= button_to t("dashboard.decline"), update_status_booking_path(booking, status: "rejected_by_teacher"), method: :patch,
        class: "btn btn-sm", style: "background-color: #eb4e5a; height: 28px; line-height: 10px; border-radius: 14px; width: 95px; color: white;",
        data: { turbo_method: :patch, turbo_frame: "booking_#{booking.id}" } %>
                        </div>
                      <% elsif booking.status == 'confirmed' %>
                        <div class="relative inline-block text-left" data-controller="cancel-dropdown" style="position: relative;">
                          <button type="button"
    class="btn btn-sm"
    style="background-color: black; height: 28px; line-height: 11px; color: white; border-radius: 14px; width: 95px; position: relative;"
    data-action="click->cancel-dropdown#toggle">
                            <%= t("dashboard.cancel") %>
                          </button>
                          <!-- Dropdown positioned absolutely so it doesn't affect button position -->
                          <div data-cancel-dropdown-target="menu"
       style="display: none; position: absolute; top: 30px; right: 0; z-index: 1000;"
       class="w-44 origin-top-right rounded-md shadow-lg bg-white border border-gray-200 focus:outline-none">
                            <%= button_to t("dashboard.cancel_as_t"), cancel_booking_path(booking, cancelled_by: "teacher", dashboard: true),
        method: :post,
        class: "block w-full text-left px-3 py-2 hover:bg-gray-50 border-0",
        style: "color: black !important; font-size: 12px; font-family: 'Inter'; background: none;",
        data: { turbo_frame: "booking_#{booking.id}" } %>
                            <%= button_to t("dashboard.cancel_as_s"), cancel_booking_path(booking, cancelled_by: "student", dashboard: true),
        method: :post,
        class: "block w-full text-left px-3 py-2 hover:bg-gray-50 border-0 border-top",
        style: "color: black !important; font-size: 12px; font-family: 'Inter'; background: none; border-top: 1px solid #e5e7eb;",
        data: { turbo_frame: "booking_#{booking.id}" } %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                    <!-- Dropdown Content -->
                    <div class="collapse mt-2" id="dropdown_<%= booking.id %>" data-controller="collapse">
                      <div class="p-2" style="border-radius: 5px;">
                        <%= link_to user_path(booking.user), data: { turbo_frame: "_top" }, class: "d-flex align-items-end" do %>
                          <% if booking.user.photo.present? %>
                            <%= cl_image_tag booking.user.photo.key, class: "avatar-showpage", alt: "avatar-bordered" %>
                          <% else %>
                            <%= image_tag "default-avatar.png", class: "avatar-showpage" %>
                          <% end %>
                          <h6 class="panel" style="margin-left: 2px;"><%= t("dashboard.view_p") %></h6>
                        <% end %>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 3px;"><i class="fa-solid fa-envelope"></i></h6>
                          <h6 class="panel" style="margin-left: 6px;"><%= booking.user.email %></h6>
                        </div>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 4px;"><i class="fa-solid fa-mobile-screen-button"></i></h6>
                          <h6 style="margin-left: 8px;"><%= booking.user.phone_number %></h6>
                        </div>
                        <div class="panel" style="margin-left: 3px;">
                          <h6><%= t("dashboard.created_at") %>
                            <%= l(booking.created_at.in_time_zone(time_zone), format: :short_day_with_time) %>
                          </h6>
                        </div>
                      </div>
                    </div>
                  </turbo-frame>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
        <h3 id="past-events" class="mt-5 mb-4"><%= t("classes.past") %></h3>
        <div>
          <% @past_event_instances_created.each do |instance| %>
            <% if instance.bookings.any? %>
              <%= link_to event_instance_path(instance) do %>
                <div class="panel mb-3">
                  <h4 class="panel d-flex align-items-center">
                    <%= instance.event.title.upcase %>
                    <div style="margin-bottom: 2px; margin-left: 5px">
                      <i class="fa-solid fa-arrow-up-right-from-square" style="font-size: 13px;"></i>
                    </div>
                  </h4>
                <% end %>
                <% time_zone_str = current_user&.time_zone.presence || "Asia/Tokyo" %>
                <% time_zone = ActiveSupport::TimeZone[time_zone_str] || ActiveSupport::TimeZone["UTC"] %>
                <h6 class="panel mb-3"> <%= instance.start_time.strftime("%Y/%m/%d (%a)") %>
                  <%= l(instance.start_time.in_time_zone(time_zone), format: :short_day_with_time) %>
                </h6>
                <% instance.bookings.each do |booking| %>
                  <turbo-frame id="booking_<%= booking.id %>">
                    <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 5px; height: 28px;">
                      <div class="d-flex align-items-end" style="margin-top: -6px;">
                        <i class="fa-solid fa-caret-right caret-icon me-1" data-booking-id="<%= booking.id %>"></i>
                        <h6 class="panel">
                          <a
                  class="text-decoration-none"
                  style="color: black;"
                  data-bs-toggle="collapse"
                  data-bs-target="#dropdown_<%= booking.id %>"
                  aria-expanded="false"
                  aria-controls="dropdown_<%= booking.id %>"
                  data-booking-id="<%= booking.id %>"
                >
                            <%= booking.user.first_name %> –
                          </h6>
                          <h6 class="panel" style="<%= 'color: #5e9e6b; font-weight: 600;' if booking.status == 'confirmed' %>">
                            <%= t("dashboard.confirmed") %>
                          </h6>
                        </div>
                      </a>
                      <% if booking.status == 'pending' %>
                        <div class="d-flex align-items-between">
                          <% if instance.active_bookings_count < instance.effective_capacity.to_i %>
                            <%= button_to t("dashboard.approve"), update_status_booking_path(booking, status: "confirmed"), method: :patch,
                      class: "btn btn-sm", style: "background-color: #9bdaa7; height: 28px; line-height: 10px; border-radius: 14px; width: 95px; color: white; margin-right: 4px",
                      data: { turbo_method: :patch, turbo_frame: "booking_#{booking.id}" } %>
                          <% else %>
                            <button class="btn btn-sm disabled" style="height: 28px; line-height: 10px; border-radius: 14px; width: 95px; color: black; margin-right: 4px;" disabled>
                              <%= t("dashboard.full") %>
                            </button>
                          <% end %>
                          <%= button_to t("dashboard.decline"), update_status_booking_path(booking, status: "cancelled"), method: :patch,
                    class: "btn btn-sm", style: "background-color: #eb4e5a; height: 28px; line-height: 10px; border-radius: 14px; width: 95px; color: white;",
                    data: { turbo_method: :patch, turbo_frame: "booking_#{booking.id}" } %>
                        </div>
                      <% elsif booking.status == 'confirmed' %>
                        <div class="relative inline-block text-left" data-controller="cancel-dropdown" style="position: relative;">
                          <button type="button"
    class="btn btn-sm"
    style="background-color: black; height: 28px; line-height: 11px; color: white; border-radius: 14px; width: 95px; position: relative;"
    data-action="click->cancel-dropdown#toggle">
                            <%= t("dashboard.cancel") %>
                          </button>
                          <!-- Dropdown positioned absolutely so it doesn't affect button position -->
                          <div data-cancel-dropdown-target="menu"
       style="display: none; position: absolute; top: 30px; right: 0; z-index: 1000;"
       class="w-44 origin-top-right rounded-md shadow-lg bg-white border border-gray-200 focus:outline-none">
                            <%= button_to t("dashboard.cancel_as_t"), cancel_booking_path(booking, cancelled_by: "teacher", dashboard: true),
        method: :post,
        class: "block w-full text-left px-3 py-2 hover:bg-gray-50 border-0",
        style: "font-size: 12px; font-family: 'Inter'; background: none;",
        data: { turbo_frame: "booking_#{booking.id}" } %>
                            <%= button_to t("dashboard.cancel_as_s"), cancel_booking_path(booking, cancelled_by: "student", dashboard: true),
        method: :post,
        class: "block w-full text-left px-3 py-2 hover:bg-gray-50 border-0 border-top",
        style: "font-size: 12px; font-family: 'Inter'; background: none; border-top: 1px solid #e5e7eb;",
        data: { turbo_frame: "booking_#{booking.id}" } %>
                          </div>
                        </div>
                      <% end %>
                    </div>
                    <!-- Dropdown with user info -->
                    <div class="collapse mt-2" id="dropdown_<%= booking.id %>" data-controller="collapse">
                      <div class="p-2" style="border-radius: 5px;">
                        <%= link_to user_path(booking.user), data: { turbo_frame: "_top" }, class: "d-flex align-items-end" do %>
                          <% if booking.user.photo.present? %>
                            <%= cl_image_tag booking.user.photo.key, class: "avatar-showpage", alt: "avatar-bordered" %>
                          <% else %>
                            <%= image_tag "default-avatar.png", class: "avatar-showpage" %>
                          <% end %>
                          <h6 class="panel" style="margin-left: 2px;"><%= t("dashboard.view_p") %></h6>
                        <% end %>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 3px;"><i class="fa-solid fa-envelope"></i></h6>
                          <h6 class="panel" style="margin-left: 6px;"><%= booking.user.email %></h6>
                        </div>
                        <div class="d-flex">
                          <h6 class="panel" style="margin-left: 4px;"><i class="fa-solid fa-mobile-screen-button"></i></h6>
                          <h6 style="margin-left: 8px;"><%= booking.user.phone_number %></h6>
                        </div>
                        <h6 class="panel" style="margin-left: 3px;"><%= t("dashboard.created_at") %>
                          <%= l(booking.created_at.in_time_zone(time_zone), format: :short_day_with_time) %>
                        </h6>
                      </div>
                    </div>
                  </turbo-frame>
                <% end %>
              </div>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
    <%# Iterating through teaching events %>
    <div class="container p-0">
    </div>
    <div class="container mb-5">
      <div class="row mx-0 mt-3">
        <% if @upcoming_event_instances_created.any? %>
          <h4 class="dashboard-h4 d-flex justify-content-start ms-0 mb-4" style="color: #292A5A"><%= t("classes.upcoming") %></h4>
          <div class="col-12 col-md-6 col-lg-6 mx-auto px-1">
            <div class="card-container mx-auto">
              <%= render "shared/event_card_iteration", event_instances: @upcoming_event_instances_created %>
            </div>
          </div>
        <% else %>
          <h4 class="dashboard-h4 d-flex justify-content-start ms-0 mb-4" style="color: #292A5A"><%= t("classes.upcoming") %></h4>
          <div class="col-12 col-md-6 col-lg-6 mx-auto px-1">
            <h6 class="dashboard-h6"><%= t("dashboard.no_upcoming") %></h6>
          </div>
        <% end %>
      </div>
    </div>
    <div class="container">
      <div class="row mx-0 mt-3">
        <% if @past_event_instances_created.any? %>
          <h4 class="dashboard-h4 d-flex justify-content-start ms-0 mb-4" style="color: #292A5A"><%= t("classes.past") %></h4>
          <div class="col-12 col-md-6 col-lg-6 mx-auto px-1">
            <div class="card-container mx-auto">
              <%= render "shared/event_card_iteration", event_instances: @past_event_instances_created %>
            </div>
          </div>
        <% else %>
          <h4 class="dashboard-h4 d-flex justify-content-start ms-0 mb-4" style="color: #292A5A"><%= t("classes.past") %></h4>
          <div class="col-12 col-md-6 col-lg-6 mx-auto px-1">
            <h6>No classes.</h6>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function (toggle) {
      const targetSelector = toggle.getAttribute('data-bs-target');
      const bookingId = toggle.getAttribute('data-booking-id');
      const carets = document.querySelectorAll(`.caret-icon[data-booking-id='${bookingId}']`);
      const target = document.querySelector(targetSelector);

      if (!target || carets.length === 0) return;

      target.addEventListener('show.bs.collapse', function () {
        carets.forEach(caret => caret.classList.add('caret-rotated'));
      });

      target.addEventListener('hide.bs.collapse', function () {
        carets.forEach(caret => caret.classList.remove('caret-rotated'));
      });
    });
  });
</script>
